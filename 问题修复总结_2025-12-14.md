# 问题修复总结

**修复日期**: 2025-12-14
**修复内容**: AI API 配置、翻译服务代理问题、数据格式处理

---

## 问题 1：AI API 密钥过期

### 问题描述
- 用户报告 AI API 无法正常工作
- 原有 API key 已过期：`sk-a4da207f6ccb772d1a524dfd50fe839a`

### 问题原因
- iFlow 平台的 API key 有效期已过
- 配置文件中使用的是旧的 API 密钥

### 解决方案
1. **更新 API 配置**
   - 文件：`ai_config.json`
   - 新 API key：`sk-17b2eca4e3459195d34f162353b5cd33`

2. **配置主备 API 架构**
   ```json
   {
     "primary": {
       "provider": "anyrouter",
       "api_key": "sk-IxAvh52Ug0PgQLRdok4TmaJcLV3M5Qdcyp98xMf4aXBAFegC",
       "model": "claude-sonnet-4-5-20250929"
     },
     "backup": {
       "provider": "iFlow",
       "api_key": "sk-17b2eca4e3459195d34f162353b5cd33",
       "model": "Qwen3-Coder-Plus"
     },
     "failover_enabled": true
   }
   ```

3. **更新环境变量**
   - 文件：`backend/.env`
   - 添加主备 API 配置项

### 修改文件
- `ai_config.json`
- `backend/.env`
- `backend/.env.example`

---

## 问题 2：AI 生成例句数据格式错误

### 问题描述
- 前端显示：**"AI 返回的数据格式不正确"**
- AI 生成例句功能无法正常使用

### 问题原因
1. **JSON 提取不完善**
   - 原代码使用简单的字符串分割提取 JSON
   - 无法处理 AI 返回的多种格式（如带 markdown 标记、前后有解释文字等）

2. **格式验证缺失**
   - 提取 JSON 后没有验证数据结构
   - 不同 AI 模型返回格式可能不同

3. **前端期望与后端返回不匹配**
   - 前端期望：`{ examples: [...] }`
   - 解析失败时返回：`{ content: "..." }`

### 解决方案

#### 1. 改进 JSON 提取逻辑
**文件**: `backend/app/services/ai_service.py:393-433`

新增 `_extract_json()` 方法，支持多种提取方式：

```python
def _extract_json(self, content: str) -> str:
    """从 AI 响应中提取 JSON 内容"""
    import re

    # 方法 1: 查找 ```json 标记
    if "```json" in content:
        match = re.search(r'```json\s*\n(.*?)\n```', content, re.DOTALL)
        if match:
            return match.group(1).strip()

    # 方法 2: 查找普通 ``` 标记
    if "```" in content:
        match = re.search(r'```\s*\n(.*?)\n```', content, re.DOTALL)
        if match:
            return match.group(1).strip()

    # 方法 3: 查找 JSON 对象（以 { 开始，以 } 结束）
    match = re.search(r'\{.*\}', content, re.DOTALL)
    if match:
        return match.group(0).strip()

    # 方法 4: 查找 JSON 数组并包装
    match = re.search(r'\[.*\]', content, re.DOTALL)
    if match:
        return '{"examples": ' + match.group(0).strip() + '}'

    return None
```

#### 2. 添加严格的格式验证
**文件**: `backend/app/services/ai_service.py:348-376`

```python
result = json.loads(json_content)

# 验证返回的 JSON 格式
if not isinstance(result, dict):
    raise ValueError("JSON 必须是对象格式")

if "examples" not in result:
    raise ValueError("JSON 中缺少 examples 字段")

if not isinstance(result["examples"], list):
    raise ValueError("examples 必须是数组")

# 验证每个例句的格式
for i, example in enumerate(result["examples"]):
    if not isinstance(example, dict):
        raise ValueError(f"第 {i+1} 个例句格式错误")
    if "sentence" not in example or "translation" not in example:
        raise ValueError(f"第 {i+1} 个例句缺少必要字段")
```

#### 3. 优化 AI Prompt
**文件**: `backend/app/services/ai_service.py:296-316`

更明确的提示词，要求 AI 只返回 JSON：

```python
prompt = f"""为单词 "{word}" 生成 {count} 个英语例句。

要求：
1. 例句涵盖不同难度（从简单到复杂）
2. 包含不同使用场景（日常对话、正式场合、俚语等）
3. 每个例句提供中文翻译
4. 说明使用场景

请严格按照以下 JSON 格式返回，不要有任何额外的文字：
{{
    "examples": [
        {{
            "sentence": "英文例句",
            "translation": "中文翻译",
            "scenario": "使用场景",
            "level": "beginner"
        }}
    ]
}}

只返回 JSON，不要有任何解释文字或 markdown 标记。"""
```

### 修改文件
- `backend/app/services/ai_service.py`

---

## 问题 3：Claude 模型名称配置错误

### 问题描述
- 后端日志显示：
  ```
  [AI Service] primary API 返回错误状态码: 403
  响应内容: {"error":{"message":"您没有调用权限此模型 claude-3-5-sonnet-20241022"}}
  ```
- 后来又出现：
  ```
  [AI Service] primary API 返回错误状态码: 404
  响应内容: {"error":"当前 API 不支持选择模型 claude-sonnet-4-5"}
  ```

### 问题原因
1. **初始配置使用了不存在的模型名称**
   - 配置的模型：`claude-3-5-sonnet-20241022`
   - 该模型不在 API 权限范围内

2. **第二次修正后模型名称仍然不正确**
   - 修正为：`claude-sonnet-4-5`
   - anyrouter API 不支持这个简写形式

3. **API 提供商要求完整的模型版本号**
   - 需要使用带日期的完整版本号

### 解决方案

#### 1. 确认可用模型列表
用户提供的 anyrouter 可用模型：
- `claude-haiku-4-5-20251001`
- `claude-opus-4-5-20251101`
- `claude-sonnet-4-5-20250929` ✓ (选用)

#### 2. 更新配置文件
**文件**: `ai_config.json`

```json
{
  "primary": {
    "provider": "anyrouter",
    "model": "claude-sonnet-4-5-20250929",
    "notes": "anyrouter 主 API - Claude Sonnet 4.5 (2025-09-29)"
  },
  "alternative_models": {
    "haiku": "claude-haiku-4-5-20251001",
    "opus": "claude-opus-4-5-20251101",
    "sonnet": "claude-sonnet-4-5-20250929"
  }
}
```

**文件**: `backend/.env`

```env
AI_PRIMARY_MODEL=claude-sonnet-4-5-20250929
```

### 修改文件
- `ai_config.json`
- `backend/.env`

---

## 问题 4：翻译服务在本地代理环境下无法工作

### 问题描述
- 用户报告："本地代理运行时，翻译服务不可用"
- 后端日志显示代理连接错误：
  ```
  urllib3.exceptions.ProxyError: ('Unable to connect to proxy',
  SSLError(SSLEOFError(8, 'EOF occurred in violation of protocol')))
  ```

### 问题原因
1. **系统环境代理干扰**
   - Windows 系统设置了 HTTP/HTTPS 代理（如 Clash）
   - Python requests 库默认使用环境变量中的代理设置
   - 有道 API 直连不需要代理，但请求被强制走代理导致失败

2. **SSL 验证与代理冲突**
   - 代理服务器的 SSL 证书与目标服务器不匹配
   - 导致 SSL 握手失败

3. **代码中未显式禁用代理**
   - 原代码：`response = requests.get(self.youdao_url, params=params, timeout=5)`
   - 没有禁用代理和 SSL 验证

### 解决方案

#### 1. 导入 urllib3 并禁用警告
**文件**: `backend/app/services/translation_service.py:1-10`

```python
import urllib3

# 禁用 SSL 警告
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
```

#### 2. 创建独立 Session 并禁用代理
**文件**: `backend/app/services/translation_service.py:73-84`

```python
# 创建 session 并禁用代理
session = requests.Session()
session.trust_env = False  # 不使用环境变量中的代理设置

# 发送请求（禁用代理和SSL验证）
response = session.get(
    self.youdao_url,
    params=params,
    timeout=10,
    verify=False,  # 禁用 SSL 验证以避免代理问题
    proxies={}  # 显式禁用代理
)
```

#### 3. 技术要点

| 配置项 | 作用 | 说明 |
|--------|------|------|
| `session.trust_env = False` | 禁用环境变量代理 | 忽略系统的 HTTP_PROXY/HTTPS_PROXY |
| `verify=False` | 禁用 SSL 验证 | 避免代理 SSL 证书问题 |
| `proxies={}` | 显式禁用代理 | 确保不使用任何代理 |
| `urllib3.disable_warnings()` | 禁用警告 | 避免 SSL 验证关闭的警告信息 |

### 修改文件
- `backend/app/services/translation_service.py`

---

## 问题 5：AI 服务代理配置（预防性修复）

### 问题描述
虽然用户没有明确报告 AI 服务的代理问题，但 AI 服务使用相同的 requests 库，可能面临同样的问题。

### 解决方案
在 `backend/app/services/ai_service.py` 中已经实现了相同的代理禁用逻辑：

```python
# 使用 requests 发送请求，禁用代理
session = requests.Session()
session.trust_env = False

response = session.post(
    api_config['endpoint'],
    headers=headers,
    json=payload,
    timeout=self.timeout,
    verify=False,
    proxies={}
)
```

### 修改文件
- `backend/app/services/ai_service.py` (已有此配置)

---

## 架构改进：主备 API 自动切换

### 新增功能
实现了 AI API 的主备自动切换机制，提高服务可用性。

### 架构设计

```
请求流程：
┌─────────────┐
│  用户请求    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────┐
│  主 API (anyrouter)     │
│  Claude Sonnet 4.5      │
└──────┬──────────────────┘
       │
       ├─ 成功 ──> 返回结果
       │
       └─ 失败
          │
          ▼
┌─────────────────────────┐
│  备用 API (iFlow)       │
│  Qwen3-Coder-Plus       │
└──────┬──────────────────┘
       │
       ├─ 成功 ──> 返回结果
       │
       └─ 失败 ──> 返回错误
```

### 核心代码
**文件**: `backend/app/services/ai_service.py:81-122`

```python
def _call_api(self, messages, temperature=0.7, max_tokens=2000):
    """调用 AI API，支持主备自动切换"""

    # 先尝试主 API
    if self.current_api == 'primary' or not self.failover_enabled:
        result = self._try_api_call(
            self.primary_api,
            messages,
            temperature,
            max_tokens,
            api_type='primary'
        )
        if result:
            return result
        elif not self.failover_enabled:
            return None

    # 主 API 失败，尝试备用 API
    if self.failover_enabled:
        print(f"[AI Service] 主 API 失败，切换到备用 API...")
        result = self._try_api_call(
            self.backup_api,
            messages,
            temperature,
            max_tokens,
            api_type='backup'
        )
        if result:
            self.current_api = 'backup'
            return result

    print(f"[AI Service] 所有 API 都失败了")
    return None
```

### 配置参数
- `failover_enabled`: 是否启用故障转移（默认 true）
- `retry_attempts`: 重试次数（默认 3）
- `timeout`: 请求超时时间（默认 30秒）

---

## 测试验证

### 1. 翻译服务测试
**测试方法**：在查询页面输入单词
**预期结果**：成功返回有道翻译结果
**实际结果**：✅ 通过
```
[有道API] 响应状态码: 200
[翻译服务] API调用成功
```

### 2. AI 生成例句测试
**测试方法**：在单词详情页点击"AI 生成例句"
**预期结果**：返回 5 个格式正确的例句
**实际结果**：✅ 通过
```
[AI Service] 尝试调用 primary API: anyrouter
[AI Service] primary API 调用成功 (anyrouter)
[AI Service] 成功解析 JSON，包含 5 个例句
```

### 3. API 故障转移测试
**测试场景**：主 API 调用失败
**预期结果**：自动切换到备用 API
**实际结果**：✅ 通过
```
[AI Service] primary API 返回错误状态码: 404
[AI Service] 主 API 失败，切换到备用 API...
[AI Service] backup API 调用成功 (iFlow)
```

---

## 配置文件变更总览

### 1. ai_config.json
```json
{
  "primary": {
    "provider": "anyrouter",
    "api_key": "sk-IxAvh52Ug0PgQLRdok4TmaJcLV3M5Qdcyp98xMf4aXBAFegC",
    "model": "claude-sonnet-4-5-20250929"
  },
  "backup": {
    "provider": "iFlow",
    "api_key": "sk-17b2eca4e3459195d34f162353b5cd33",
    "model": "Qwen3-Coder-Plus"
  },
  "alternative_models": {
    "haiku": "claude-haiku-4-5-20251001",
    "opus": "claude-opus-4-5-20251101",
    "sonnet": "claude-sonnet-4-5-20250929"
  },
  "failover_enabled": true,
  "retry_attempts": 3,
  "timeout": 30
}
```

### 2. backend/.env
```env
# AI API 主配置（anyrouter - 优先使用）
AI_PRIMARY_PROVIDER=anyrouter
AI_PRIMARY_API_KEY=sk-IxAvh52Ug0PgQLRdok4TmaJcLV3M5Qdcyp98xMf4aXBAFegC
AI_PRIMARY_BASE_URL=https://c.cspok.cn/v1
AI_PRIMARY_MODEL=claude-sonnet-4-5-20250929

# AI API 备用配置（iFlow - 主 API 失败时使用）
AI_BACKUP_PROVIDER=iFlow
AI_BACKUP_API_KEY=sk-17b2eca4e3459195d34f162353b5cd33
AI_BACKUP_BASE_URL=https://apis.iflow.cn/v1
AI_BACKUP_MODEL=Qwen3-Coder-Plus

# AI 故障转移配置
AI_FAILOVER_ENABLED=true
AI_RETRY_ATTEMPTS=3
AI_TIMEOUT=30
```

### 3. backend/.env.example
添加了 AI API 配置说明和示例。

---

## 代码文件变更总览

### 1. backend/app/services/ai_service.py
**修改行数**: 约 200 行

**主要变更**：
- ✅ 重构初始化方法，支持主备 API 配置
- ✅ 新增 `_try_api_call()` 方法，统一 API 调用逻辑
- ✅ 改进 `_call_api()` 方法，实现主备自动切换
- ✅ 新增 `_extract_json()` 方法，智能提取 JSON
- ✅ 优化 `generate_examples()` 方法，添加格式验证
- ✅ 更新所有返回值，添加 `provider`、`api_used` 等元信息

### 2. backend/app/services/translation_service.py
**修改行数**: 约 20 行

**主要变更**：
- ✅ 导入 urllib3，禁用 SSL 警告
- ✅ 创建独立 Session，禁用环境代理
- ✅ 显式禁用 SSL 验证和代理
- ✅ 增加超时时间（5秒 → 10秒）

### 3. backend/app/routes/ai.py
**变更**: 无（已有完善的错误处理）

---

## 最佳实践总结

### 1. 代理环境下的 HTTP 请求
在本地开发环境使用代理（如 Clash）时，访问国内 API 应：
```python
session = requests.Session()
session.trust_env = False  # 禁用环境代理
response = session.request(
    method='GET/POST',
    url=api_url,
    verify=False,  # 禁用 SSL 验证
    proxies={},    # 显式禁用代理
    timeout=10
)
```

### 2. API 服务可用性设计
- 实现主备 API 架构
- 添加自动故障转移机制
- 记录详细的日志，便于问题排查
- 在返回结果中包含 API 使用信息

### 3. AI 响应格式处理
- 使用正则表达式提取 JSON
- 支持多种常见格式（markdown、纯文本、带注释等）
- 添加严格的格式验证
- 在 Prompt 中明确要求返回格式

### 4. 配置管理
- 主配置文件：`ai_config.json`（便于手动编辑）
- 环境变量：`.env`（便于部署）
- 示例文件：`.env.example`（便于新用户上手）
- 记录可用模型列表（`alternative_models`）

---

## 后续优化建议

### 1. 配置统一化
当前 AI 配置分散在两个地方：
- `ai_config.json` (实际使用)
- `.env` (仅作记录)

**建议**：统一从 `.env` 读取，删除 `ai_config.json`，或反之。

### 2. 增加缓存机制
对于 AI 生成的例句，可以添加缓存：
- 相同单词的例句请求可以从缓存返回
- 减少 API 调用次数，节省成本

### 3. 日志优化
**建议**：
- 使用 Python logging 模块替代 print
- 添加日志级别（DEBUG/INFO/ERROR）
- 将日志输出到文件，便于追踪

### 4. 错误重试策略
当前主备切换是一次性的，可以优化为：
- 主 API 失败后自动重试 N 次
- 备用 API 失败后回退到主 API
- 添加指数退避策略

### 5. 监控告警
**建议**：
- 记录 API 调用成功率
- 记录响应时间
- API 失败时发送告警通知

---

## 相关文档

- [AI助手功能优化总结v2.md](./AI助手功能优化总结v2.md) - AI 功能整体优化
- [BACKEND_LEARNING_GUIDE.md](./BACKEND_LEARNING_GUIDE.md) - 后端代码学习指南
- [后端API文档](./backend/API_FE_DOC.md) - API 接口文档

---

## 附录：错误日志示例

### 问题 1: 模型权限错误
```
[AI Service] 尝试调用 primary API: anyrouter
[AI Service] primary API 返回错误状态码: 403
[AI Service] 响应内容: {"error":{"message":"您没有调用权限此模型 claude-3-5-sonnet-20241022"}}
```

### 问题 2: 模型不存在错误
```
[AI Service] 尝试调用 primary API: anyrouter
[AI Service] primary API 返回错误状态码: 404
[AI Service] 响应内容: {"error":"当前 API 不支持选择模型 claude-sonnet-4-5"}
```

### 问题 3: 代理连接错误
```
urllib3.exceptions.MaxRetryError: HTTPSConnectionPool(host='openapi.youdao.com', port=443):
Max retries exceeded with url: /api?q=yummy&...
(Caused by ProxyError('Unable to connect to proxy',
SSLError(SSLEOFError(8, 'EOF occurred in violation of protocol (_ssl.c:1129)'))))
```

### 成功日志示例
```
[AI Service] 初始化完成
[AI Service] 主 API: anyrouter (claude-sonnet-4-5-20250929)
[AI Service] 备用 API: iFlow (Qwen3-Coder-Plus)
[AI Service] 故障转移: 启用
[AI Service] 尝试调用 primary API: anyrouter
[AI Service] primary API 调用成功 (anyrouter)
[AI Service] AI 返回内容长度: 1181
[AI Service] 成功解析 JSON，包含 5 个例句
```

---

**文档版本**: 1.0
**最后更新**: 2025-12-14 20:00
**维护者**: AI Assistant (Claude Sonnet 4.5)
