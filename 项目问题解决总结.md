# 项目功能实现总结文档

## 1. 概述

本文档总结了电视剧词汇学习助手项目在本次对话中完成的所有任务、遇到的问题及解决方案。项目使用 Flask 3.0 后端和 Vue 3 前端，在此之前已实现单词发音、深色模式、单词导出等功能。

## 2. 完成的主要任务

### 2.1 解决 Clash 代理导致 pip 安装失败
### 2.2 修复深色模式下查询页面背景颜色问题
### 2.3 修复 PDF 导出中文乱码问题
### 2.4 配置有道翻译 API 并添加调试日志

---

## 3. 问题与解决方案详解

### 3.1 Clash 代理导致 pip 安装失败

#### 错误现象
```
ValueError: check_hostname requires server_hostname
```

#### 原因分析
1. Clash 代理使用 TUN/增强模式，在系统底层拦截所有网络连接
2. 代理拦截 HTTPS 连接时，SSL 证书验证失败
3. 即使配置了 DIRECT 规则，TUN 模式仍会干扰连接

#### 解决过程

**尝试 1**: 在 Clash 配置文件中添加 PyPI DIRECT 规则
- 结果：失败，发现用户有多个配置文件

**尝试 2**: 找到正确的配置文件并添加规则
- 结果：失败，规则位置不对

**尝试 3**: 将规则移到 `rules:` 最前面
- 结果：失败，修改的不是实际使用的配置文件

**尝试 4**: 在正确的配置文件添加规则
- 文件：`C:\Users\psk13\.config\clash\profiles\1762238429385.yml`
- 位置：`rules:` 部分的最前面
- 内容：
```yaml
rules:
    - DOMAIN-SUFFIX,pypi.org,DIRECT
    - DOMAIN-SUFFIX,pythonhosted.org,DIRECT
    - DOMAIN-SUFFIX,files.pythonhosted.org,DIRECT
    - DOMAIN-SUFFIX,pypi.tuna.tsinghua.edu.cn,DIRECT
```
- 结果：仍然失败，TUN 模式在更底层拦截

#### 最终解决方案

**方案 1: 临时关闭 Clash 系统代理（推荐）**
```bash
# 步骤：
# 1. 在 Clash 托盘图标右键 → 关闭"系统代理"
# 2. pip install 安装所需包
# 3. 重新开启"系统代理"
```

**方案 2: 配置 pip 使用清华镜像源**

创建文件 `C:\Users\psk13\pip\pip.ini`：
```ini
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
trusted-host = pypi.tuna.tsinghua.edu.cn

[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
```

**方案 3: 组合方案（最佳）**
- Clash 配置 DIRECT 规则
- pip.ini 配置清华源
- 安装时临时关闭系统代理

#### 相关文档
- `Clash代理配置pip解决方案.md` - 详细配置指南
- `测试pip下载.md` - 问题诊断步骤
- `pip安装助手.bat` - 自动化安装脚本

---

### 3.2 深色模式下查询页面背景仍为白色

#### 错误现象
用户切换到深色模式后，查询页面（/query）的主背景仍然是白色/浅灰色，只有卡片组件变成了深色。由于查询页面比较空旷，组件遮挡少，背景色问题特别明显。

#### 原因分析
1. `QueryView.vue` 中有部分硬编码颜色（次要原因）
2. **主要原因**：`App.vue` 中 `.main-content` 的背景色硬编码为 `#f0f2f5`
3. 查询页面内容较少，背景暴露面积大

#### 解决方案

**修改 1: App.vue - 主内容区域背景**

文件：`frontend/src/App.vue`

```vue
<style>
.main-content {
  /* 修改前 */
  background: #f0f2f5;

  /* 修改后 */
  background: var(--app-bg-color, #f0f2f5);

  padding: 20px;
  overflow-y: auto;
}
</style>
```

**修改 2: QueryView.vue - 组件内部颜色**

文件：`frontend/src/views/QueryView.vue`

```vue
<style scoped>
.query-card {
  border-radius: 12px;
  /* 新增 */
  background-color: var(--app-card-bg, #ffffff);
}

.title {
  font-size: 32px;
  margin-bottom: 10px;
  /* 修改前: color: #303133 */
  color: var(--app-text-color, #303133);
  text-align: center;
}

.subtitle {
  text-align: center;
  /* 修改前: color: #909399 */
  color: var(--app-text-secondary, #909399);
  margin-bottom: 30px;
}

.recent-queries h3 {
  margin-bottom: 15px;
  /* 修改前: color: #606266 */
  color: var(--app-text-color, #606266);
}
</style>
```

**修改 3: dark-mode.css - 添加新的 CSS 变量**

文件：`frontend/src/styles/dark-mode.css`

```css
/* 浅色模式 */
html:not(.dark) {
  --app-bg-color: #f5f7fa;
  --app-text-color: #303133;
  --app-text-secondary: #909399;  /* 新增 */
  --app-card-bg: #ffffff;
  --app-border-color: #dcdfe6;
}

/* 深色模式 */
html.dark {
  --app-bg-color: #0a0a0a;
  --app-text-color: #e5eaf3;
  --app-text-secondary: #909399;  /* 新增 */
  --app-card-bg: #141414;
  --app-border-color: #30303a;
}
```

#### 测试步骤
1. 保存所有修改的文件
2. **重启前端开发服务器**（仅刷新页面不会生效）
3. 访问 `http://localhost:5173/query`
4. 切换深色模式，验证背景色正确变化

#### 关键发现
用户反馈："由于查询页面比较空旷，所以组件遮挡不多，单独只变组件颜色，效果不明显，其余页面组件较多或者组件面积较大，效果比较明显。"

这说明主背景色（`.main-content`）的适配比组件内部颜色更重要。

---

### 3.3 PDF 导出中文乱码问题

#### 错误现象
导出的 PDF 文件中，所有中文文本显示为黑色方块（乱码），英文正常显示。

#### 原因分析
reportlab 库默认使用 Helvetica 字体，该字体不包含中文字符集，因此无法正确渲染中文。

#### 解决方案

文件：`backend/app/services/export_service.py`

**步骤 1: 注册中文字体**

```python
@staticmethod
def export_to_pdf(words, user_info=None):
    """导出单词到 PDF"""
    if not REPORTLAB_AVAILABLE:
        raise ImportError("reportlab 库未安装，请运行: pip install reportlab")

    # 注册中文字体
    import os
    import platform
    from reportlab.pdfbase import pdfmetrics
    from reportlab.pdfbase.ttfonts import TTFont

    try:
        system = platform.system()
        if system == 'Windows':
            # 方案 1: 微软雅黑
            font_path = 'C:/Windows/Fonts/msyh.ttc'
            if os.path.exists(font_path):
                pdfmetrics.registerFont(TTFont('Chinese', font_path))
                chinese_font = 'Chinese'
            else:
                # 方案 2: 黑体
                font_path = 'C:/Windows/Fonts/simhei.ttf'
                if os.path.exists(font_path):
                    pdfmetrics.registerFont(TTFont('Chinese', font_path))
                    chinese_font = 'Chinese'
                else:
                    chinese_font = 'Helvetica'  # 降级到默认字体
        else:
            # Linux/Mac 可添加其他字体路径
            chinese_font = 'Helvetica'
    except Exception as e:
        print(f"字体加载失败: {e}")
        chinese_font = 'Helvetica'
```

**步骤 2: 应用中文字体到所有文本样式**

```python
    # 标题样式
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=18,
        textColor=colors.HexColor('#4472C4'),
        spaceAfter=12,
        alignment=TA_CENTER,
        fontName=chinese_font  # 使用中文字体
    )

    # 正文样式
    body_style = ParagraphStyle(
        'BodyText',
        parent=styles['BodyText'],
        fontSize=10,
        fontName=chinese_font  # 使用中文字体
    )

    # 表格样式
    table_style = TableStyle([
        # 表头
        ('FONTNAME', (0, 0), (-1, 0), chinese_font),  # 中文字体
        ('FONTSIZE', (0, 0), (-1, 0), 11),
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#4472C4')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),

        # 数据行
        ('FONTNAME', (0, 1), (-1, -1), chinese_font),  # 中文字体
        ('FONTSIZE', (0, 1), (-1, -1), 9),

        # ... 其他样式
    ])

    # 页脚样式
    footer_style = ParagraphStyle(
        'Footer',
        parent=styles['Normal'],
        fontSize=8,
        textColor=colors.grey,
        alignment=TA_CENTER,
        fontName=chinese_font  # 使用中文字体
    )
```

#### 关键点
1. **字体文件路径**：Windows 系统字体位于 `C:/Windows/Fonts/`
2. **字体格式**：`.ttc` (TrueType Collection) 和 `.ttf` (TrueType Font) 都支持
3. **降级处理**：如果中文字体加载失败，降级到 Helvetica 避免程序崩溃
4. **全面应用**：必须在所有文本元素（标题、正文、表格、页脚）中应用中文字体

#### 测试步骤
1. 重启后端服务器
2. 导出包含中文的单词列表
3. 打开 PDF 文件验证中文显示正常

---

### 3.4 有道翻译 API 配置与调试

#### 问题现象
用户在 `.env` 文件中配置了有道 API 密钥，但查询单词时仍然返回模拟数据，API 未被调用。

#### 配置检查

**文件：`backend/.env`**
```ini
# 有道翻译API
YOUDAO_APP_KEY=3ae3f392772d7fba
YOUDAO_APP_SECRET=JaThett8QfjkGDhA2Cobvq0jVvUh85un

# 数据库配置
DATABASE_URL=sqlite:///vocab_learner.db

# Flask配置
FLASK_ENV=development
SECRET_KEY=your-secret-key-here
```

#### 添加调试日志

文件：`backend/app/services/translation_service.py`

```python
def translate(self, word):
    """翻译单词"""
    app_key = current_app.config.get('YOUDAO_APP_KEY')
    app_secret = current_app.config.get('YOUDAO_APP_SECRET')

    # 调试日志 - 查看配置是否加载
    print(f"[翻译服务] 查询单词: {word}")
    print(f"[翻译服务] APP_KEY: {app_key[:10] if app_key else 'None'}...")
    print(f"[翻译服务] APP_SECRET: {'已配置' if app_secret else '未配置'}")

    if app_key and app_secret:
        print(f"[翻译服务] 尝试调用有道API...")
        result = self._translate_with_youdao(word, app_key, app_secret)
        if result:
            print(f"[翻译服务] API调用成功")
            return result
        else:
            print(f"[翻译服务] API调用失败，使用模拟数据")
    else:
        print(f"[翻译服务] API未配置，使用模拟数据")

    return self._get_mock_translation(word)

def _translate_with_youdao(self, word, app_key, app_secret):
    """使用有道翻译API"""
    try:
        # 生成签名
        salt = str(uuid.uuid1())
        curtime = str(int(time.time()))
        sign_str = app_key + word + salt + curtime + app_secret
        sign = hashlib.sha256(sign_str.encode('utf-8')).hexdigest()

        # 请求参数
        params = {
            'q': word,
            'from': 'en',
            'to': 'zh-CHS',
            'appKey': app_key,
            'salt': salt,
            'sign': sign,
            'signType': 'v3',
            'curtime': curtime
        }

        # 调试日志 - API 请求
        print(f"[有道API] 请求URL: {self.youdao_url}")
        print(f"[有道API] 请求参数: q={word}, from=en, to=zh-CHS")

        response = requests.get(self.youdao_url, params=params, timeout=5)
        data = response.json()

        # 调试日志 - API 响应
        print(f"[有道API] 响应状态码: {response.status_code}")
        print(f"[有道API] 响应数据: {data}")

        if data.get('errorCode') == '0':
            # 解析成功响应
            basic = data.get('basic', {})
            translation = data.get('translation', [])

            return {
                'phonetic': basic.get('phonetic', ''),
                'translation': '; '.join(translation) if translation else '',
                'definition': '; '.join(basic.get('explains', [])) if basic.get('explains') else '',
                'examples': self._extract_examples(data.get('web', []))
            }
        else:
            print(f"[有道API] 错误代码: {data.get('errorCode')}")

        return None

    except Exception as e:
        # 调试日志 - 异常信息
        print(f"[有道API] 异常: {str(e)}")
        import traceback
        traceback.print_exc()
        return None
```

#### 调试步骤
1. 确保 `.env` 文件在 `backend/` 目录下
2. 在 IDE 中启动后端服务器：`python run.py`
3. 查看控制台输出的调试日志
4. 根据日志输出判断问题：
   - 如果显示 "API未配置"：`.env` 文件未正确加载
   - 如果显示 "API调用失败"：检查响应状态码和错误代码
   - 如果显示异常信息：检查网络连接或 API 密钥是否正确

#### 可能的问题
1. **配置未加载**：`.env` 文件位置错误或未安装 `python-dotenv`
2. **API 密钥错误**：密钥复制有误或已失效
3. **网络问题**：Clash 代理拦截 API 请求（需临时关闭代理测试）
4. **API 配额限制**：免费版 API 调用次数用尽

---

### 3.5 启动后端时缺少 colorama 模块

#### 错误现象
```
PS C:\AIProject\backend> python run.py
Traceback (most recent call last):
  ...
ModuleNotFoundError: No module named 'colorama'
```

#### 原因分析
Flask 的 Click 库需要 `colorama` 来实现 Windows 终端的彩色输出，但该模块未安装。

#### 解决方案
```bash
# 方案 1: 直接安装（如果 Clash 代理有问题，先关闭代理）
pip install colorama

# 方案 2: 使用清华源
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple colorama

# 方案 3: 如果已有 requirements.txt，更新依赖
pip install -r requirements.txt
```

#### 建议
将 `colorama` 添加到 `backend/requirements.txt` 中，避免其他环境出现同样问题：
```txt
# ... 其他依赖
colorama>=0.4.6
```

---

## 4. 关键技术要点

### 4.1 CSS 变量与深色模式
- 使用 CSS 变量（`--app-bg-color`）实现主题切换
- 必须在根元素（`html`）上定义变量
- 组件中使用 `var(--variable-name, fallback-value)` 引用

### 4.2 reportlab 中文支持
- 需要注册 TrueType 字体文件
- Windows 系统字体路径：`C:/Windows/Fonts/`
- 必须在所有文本样式中应用注册的字体

### 4.3 Clash 代理与 Python 包管理
- TUN/增强模式会拦截底层网络连接
- DIRECT 规则在 TUN 模式下可能不生效
- 推荐使用国内镜像源 + 临时关闭代理

### 4.4 Flask 配置管理
- `.env` 文件必须在项目根目录或 `backend/` 目录
- 需要安装 `python-dotenv` 库
- 使用 `current_app.config.get()` 获取配置

---

## 5. 文件修改清单

### 前端文件
1. `frontend/src/App.vue` - 主内容区域背景色
2. `frontend/src/views/QueryView.vue` - 查询页面颜色适配
3. `frontend/src/styles/dark-mode.css` - 新增 CSS 变量

### 后端文件
1. `backend/app/services/export_service.py` - PDF 中文字体支持
2. `backend/app/services/translation_service.py` - 有道 API 调试日志
3. `backend/.env` - 有道 API 配置
4. `backend/requirements.txt` - 添加 colorama 依赖（建议）

### 配置文件
1. `C:\Users\psk13\.config\clash\profiles\1762238429385.yml` - Clash 代理规则
2. `C:\Users\psk13\pip\pip.ini` - pip 镜像源配置

### 文档文件
1. `Clash代理配置pip解决方案.md` - 代理问题详细指南
2. `测试pip下载.md` - 问题诊断步骤
3. `pip安装助手.bat` - 自动化安装脚本

---

## 6. 待完成任务

1. **有道 API 调试**
   - 安装 colorama: `pip install colorama`
   - 在 IDE 中启动后端查看日志
   - 根据日志输出定位问题

2. **测试验证**
   - PDF 中文导出效果
   - 深色模式所有页面背景
   - 有道 API 实际调用

3. **代码优化**（可选）
   - 将 colorama 添加到 requirements.txt
   - 完善错误处理
   - 添加 API 调用失败重试机制

---

## 7. 经验总结

1. **深色模式适配**：不仅要考虑组件内部颜色，更要注意主背景色，特别是内容较少的页面
2. **代理问题排查**：需要了解代理软件的工作模式（TUN vs HTTP），底层拦截可能绕过规则配置
3. **中文字体处理**：PDF 生成时必须注册并全面应用中文字体，缺一不可
4. **调试日志重要性**：详细的日志能快速定位 API 调用问题
5. **前端热重载限制**：某些修改（如 App.vue 的样式）需要重启开发服务器才能生效

---

## 8. 参考资源

- [reportlab 官方文档](https://www.reportlab.com/docs/reportlab-userguide.pdf)
- [有道翻译 API 文档](https://ai.youdao.com/DOCSIRMA/html/自然语言翻译/API文档/文本翻译服务/文本翻译服务-API文档.html)
- [Vue 3 深色模式最佳实践](https://vuejs.org/guide/best-practices/production-deployment.html)
- [Clash 配置指南](https://clash.wiki/)
- [PyPI 清华镜像使用帮助](https://mirrors.tuna.tsinghua.edu.cn/help/pypi/)

---

**文档创建时间**: 2025-11-16
**项目路径**: C:\AIProject
**最后更新**: 本次对话结束时
