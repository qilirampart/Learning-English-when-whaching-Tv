# 项目架构与部署关系分析

## 📊 项目概览

**项目名称：** 美剧单词学习助手  
**架构模式：** 前后端分离  
**部署平台：** Railway（后端）+ Vercel（前端）  
**版本控制：** GitHub  

---

## 🏗️ 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户浏览器                              │
│                    (Chrome, Firefox, etc.)                      │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             │ HTTPS
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                   Vercel CDN（全球加速）                         │
│                  学习前端静态资源                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                ┌────────────┴─────────────┐
                │                          │
                ↓                          ↓
    ┌─────────────────────┐    ┌──────────────────────┐
    │   静态文件 (HTML)    │    │   API 请求 (/api/*) │
    │   CSS, JS, 图片      │    │                      │
    └─────────────────────┘    └──────────┬───────────┘
                                          │
                                          │ HTTPS (Proxy)
                                          ↓
                            ┌──────────────────────────────┐
                            │   Railway 应用服务器          │
                            │   Flask + Gunicorn           │
                            │   Python 3.11.14             │
                            └──────────┬───────────────────┘
                                       │
                            ┌──────────┴───────────┐
                            │                      │
                            ↓                      ↓
                ┌─────────────────────┐  ┌──────────────────┐
                │  SQLite 数据库       │  │  有道翻译 API     │
                │  (单词、学习记录)     │  │  (可选)          │
                └─────────────────────┘  └──────────────────┘
```

---

## 📦 技术栈详解

### 前端技术栈 (Frontend)

```
┌─────────────────────────────────────┐
│         Vue.js 生态系统              │
├─────────────────────────────────────┤
│ 框架: Vue 3 (Composition API)       │
│ 构建: Vite 4                        │
│ 路由: Vue Router 4                  │
│ 状态: Pinia                         │
│ HTTP: Axios                         │
│ UI: 自定义组件                       │
└─────────────────────────────────────┘
```

**构建产物：**
- HTML + CSS + JavaScript (打包压缩)
- 单页应用 (SPA)
- 静态文件托管在 Vercel CDN

### 后端技术栈 (Backend)

```
┌─────────────────────────────────────┐
│         Python Flask 生态            │
├─────────────────────────────────────┤
│ 框架: Flask 3.0.0                   │
│ WSGI: Gunicorn 21.2.0               │
│ ORM: SQLAlchemy 3.1.1               │
│ 数据库: SQLite                       │
│ CORS: Flask-CORS 4.0.0              │
│ HTTP: Requests 2.31.0               │
│ 环境: python-dotenv 1.0.0           │
└─────────────────────────────────────┘
```

**运行时环境：**
- Python 3.11.14
- Linux x86_64 (Railway 容器)

---

## 🌐 域名与路由关系

### 域名映射关系

```
用户访问域名
    │
    ├─→ https://learning-english-when-whaching-tv.vercel.app
    │       ↓
    │   Vercel DNS 解析
    │       ↓
    │   Vercel CDN (全球边缘节点)
    │       ↓
    │   前端静态资源
    │
    └─→ https://rare-wonder-production.up.railway.app
            ↓
        Railway DNS 解析
            ↓
        Railway 服务器 (us-west2)
            ↓
        Flask 应用
```

### 路由分配

#### 前端路由 (Vercel)

```
https://learning-english-when-whaching-tv.vercel.app
├── /                          → 首页/统计页面
├── /query                     → 单词查询页面
├── /words                     → 单词库页面
├── /learning                  → 学习计划页面
├── /statistics               → 学习统计页面
└── /api/*                    → 代理到后端 (Proxy)
        ↓
        转发到 Railway
```

#### 后端路由 (Railway)

```
https://rare-wonder-production.up.railway.app
└── /api/
    ├── /words/
    │   ├── GET    /query              → 查询单词翻译
    │   ├── GET    /list               → 获取单词列表
    │   ├── GET    /<id>               → 获取单词详情
    │   ├── POST   /                   → 添加单词
    │   ├── PUT    /<id>               → 更新单词
    │   └── DELETE /<id>               → 删除单词
    │
    ├── /learning/
    │   ├── GET    /today              → 今日待复习
    │   ├── GET    /plan               → 学习计划
    │   └── POST   /review             → 提交复习结果
    │
    └── /statistics/
        ├── GET    /overview           → 统计概览
        └── GET    /tv_shows           → 剧集统计
```

---

## 🔄 数据流向详解

### 1. 用户查询单词流程

```
用户输入 "hello" 并点击查询
    ↓
前端 Vue 组件 (QueryView.vue)
    ↓
Axios 发送请求: GET /api/words/query?word=hello
    ↓
Vercel 检测到 /api/* 路径
    ↓
Vercel Rewrite 规则触发
    ↓
代理请求到: https://rare-wonder-production.up.railway.app/api/words/query?word=hello
    ↓
Railway 接收请求
    ↓
Flask 路由匹配: words.bp → query()
    ↓
检查 CORS 头: Access-Control-Allow-Origin
    ↓
调用翻译服务 (有道 API 或模拟数据)
    ↓
返回 JSON 数据:
{
  "code": 200,
  "data": {
    "word": "hello",
    "translation": "你好",
    "pronunciation": "həˈloʊ",
    ...
  }
}
    ↓
Vercel 代理返回给前端
    ↓
前端接收数据并渲染
    ↓
用户看到翻译结果
```

### 2. 页面加载流程

```
用户访问: https://learning-english-when-whaching-tv.vercel.app
    ↓
DNS 解析 → Vercel 服务器
    ↓
Vercel CDN 返回 index.html
    ↓
浏览器解析 HTML
    ↓
加载 CSS (dist/assets/*.css)
    ↓
加载 JS (dist/assets/*.js)
    ↓
Vue 应用启动
    ↓
Router 匹配路由
    ↓
组件挂载
    ↓
组件发起 API 请求 (统计数据)
    ↓
GET /api/statistics/overview
    ↓
代理到 Railway
    ↓
返回数据并渲染
    ↓
页面完全加载
```

---

## 🚀 GitHub、Railway、Vercel 三者关系

### 关系图

```
┌─────────────────────────────────────────────────────────────┐
│                       GitHub 仓库                            │
│     https://github.com/qilirampart/                         │
│            Learning-English-when-whaching-Tv                │
│                                                             │
│  ├── backend/        (后端代码)                             │
│  ├── frontend/       (前端代码)                             │
│  ├── railway.json    (Railway 配置)                        │
│  ├── requirements.txt                                      │
│  └── README.md                                             │
└──────────────┬─────────────────────┬────────────────────────┘
               │                     │
               │ Git Push            │ Git Push
               │ (自动触发)           │ (自动触发)
               ↓                     ↓
    ┌──────────────────┐   ┌──────────────────┐
    │   Railway        │   │    Vercel        │
    │   (后端部署)      │   │   (前端部署)      │
    └──────────────────┘   └──────────────────┘
               │                     │
               │ 自动构建             │ 自动构建
               │ & 部署               │ & 部署
               ↓                     ↓
    ┌──────────────────┐   ┌──────────────────┐
    │ Railway 服务器    │   │  Vercel CDN      │
    │ Flask 应用运行    │   │  静态文件托管     │
    └──────────────────┘   └──────────────────┘
               │                     │
               └──────────┬──────────┘
                         │
                    API 通信 (HTTPS)
                         │
                         ↓
                    用户浏览器
```

### 工作流程

#### 1️⃣ 代码提交阶段

```bash
开发者本地
    ↓
git add .
git commit -m "Update features"
git push origin main
    ↓
GitHub 仓库更新
    ↓
触发 Webhooks
    ├─→ Railway Webhook (检测到 backend/ 变化)
    └─→ Vercel Webhook (检测到 frontend/ 变化)
```

#### 2️⃣ Railway 自动部署

```
GitHub Push 触发
    ↓
Railway 检测到代码更新
    ↓
拉取最新代码
    ↓
读取 railway.json 配置
    ↓
执行构建命令
    ├─ 安装 Python 3.11
    ├─ 安装依赖: pip install -r requirements.txt
    └─ 配置环境变量
    ↓
启动应用: gunicorn run:app --bind 0.0.0.0:$PORT
    ↓
健康检查通过
    ↓
部署完成 ✅
    ↓
更新域名: rare-wonder-production.up.railway.app
```

#### 3️⃣ Vercel 自动部署

```
GitHub Push 触发
    ↓
Vercel 检测到代码更新
    ↓
拉取最新代码
    ↓
读取 vercel.json 配置
    ↓
执行构建命令
    ├─ npm install (安装依赖)
    ├─ npm run build (Vite 构建)
    └─ 生成 dist/ 目录
    ↓
部署到 CDN
    ├─ 上传静态文件到全球边缘节点
    ├─ 配置 Rewrite 规则 (API 代理)
    └─ 配置环境变量
    ↓
部署完成 ✅
    ↓
更新域名: learning-english-when-whaching-tv.vercel.app
```

---

## 🌍 服务器部署详解

### Railway 服务器

```
┌─────────────────────────────────────────────┐
│         Railway 容器环境                     │
├─────────────────────────────────────────────┤
│ 地区: us-west2 (美国西部)                    │
│ 系统: Linux x86_64                          │
│ 构建器: Railpack 0.11.0                     │
│ Python: 3.11.14                             │
│ 内存: 动态分配                               │
│ CPU: 共享                                   │
│ 存储: 临时文件系统 (重启清空)                 │
└─────────────────────────────────────────────┘

运行时环境:
├── Python 虚拟环境
├── Gunicorn (WSGI 服务器)
│   ├── Workers: 默认 1 个
│   ├── 超时: 30 秒
│   └── 端口: $PORT (Railway 动态分配)
├── Flask 应用
├── SQLite 数据库文件
└── 环境变量 (从 Railway 注入)
```

**特点：**
- ✅ 自动重启 (on failure)
- ✅ 零停机时间部署
- ✅ 自动扩缩容
- ✅ 免费 SSL 证书
- ⚠️ 数据非持久化 (需要使用外部数据库)

### Vercel CDN

```
┌─────────────────────────────────────────────┐
│         Vercel 全球 CDN 网络                 │
├─────────────────────────────────────────────┤
│ 边缘节点: 全球 100+ 个                       │
│ 协议: HTTP/2, HTTP/3                        │
│ SSL: 自动 Let's Encrypt                     │
│ 缓存: 智能边缘缓存                           │
│ DDoS: 自动防护                              │
└─────────────────────────────────────────────┘

边缘节点分布:
├── 亚洲 (Asia)
│   ├── 香港 (HKG)
│   ├── 新加坡 (SIN)
│   ├── 东京 (NRT)
│   └── 首尔 (ICN)
├── 北美 (North America)
│   ├── 旧金山 (SFO)
│   ├── 洛杉矶 (LAX)
│   └── 纽约 (EWR)
└── 欧洲 (Europe)
    ├── 伦敦 (LHR)
    ├── 法兰克福 (FRA)
    └── 阿姆斯特丹 (AMS)
```

**特点：**
- ✅ 全球加速 (自动选择最近节点)
- ✅ 无限带宽
- ✅ 自动缓存优化
- ✅ 零配置 HTTPS
- ✅ 原子部署 (不会有半成品)

---

## 🔐 域名与 SSL 证书

### 域名层级

```
顶级域名 (TLD)
    ├── .vercel.app (Vercel 提供)
    │   └── learning-english-when-whaching-tv.vercel.app
    │       ├── 类型: 免费子域名
    │       ├── SSL: 自动 (Let's Encrypt)
    │       └── DNS: Vercel 管理
    │
    └── .railway.app (Railway 提供)
        └── rare-wonder-production.up.railway.app
            ├── 类型: 免费子域名
            ├── SSL: 自动 (Let's Encrypt)
            └── DNS: Railway 管理
```

### SSL/TLS 证书

```
┌─────────────────────────────────────────┐
│       HTTPS 加密通信                     │
├─────────────────────────────────────────┤
│ 前端证书:                                │
│   颁发机构: Let's Encrypt               │
│   有效期: 90 天 (自动续期)               │
│   加密协议: TLS 1.3                     │
│   证书类型: Domain Validation (DV)      │
│                                         │
│ 后端证书:                                │
│   颁发机构: Let's Encrypt               │
│   有效期: 90 天 (自动续期)               │
│   加密协议: TLS 1.3                     │
│   证书类型: Domain Validation (DV)      │
└─────────────────────────────────────────┘
```

---

## 💾 数据存储架构

### 当前架构 (SQLite)

```
┌─────────────────────────────────────────┐
│      Railway 容器文件系统                │
├─────────────────────────────────────────┤
│                                         │
│  /app/backend/instance/                 │
│      └── vocab_learner.db               │
│          ├── words 表                   │
│          ├── learning_plans 表          │
│          ├── query_logs 表              │
│          └── review_logs 表             │
│                                         │
│  ⚠️ 警告: 重启容器会清空数据             │
└─────────────────────────────────────────┘
```

### 推荐架构 (PostgreSQL)

```
┌─────────────────────────────────────────┐
│         Railway PostgreSQL               │
│         (持久化数据库)                    │
├─────────────────────────────────────────┤
│                                         │
│  自动备份                                │
│  持久化存储                              │
│  独立扩展                                │
│  更好的性能                              │
│                                         │
└─────────────────────────────────────────┘
         ↑
         │ DATABASE_URL
         │
┌────────┴────────┐
│  Flask 应用      │
│  (通过 SQLAlchemy)│
└─────────────────┘
```

---

## 🔄 请求响应时序图

### 完整的 API 请求流程

```
用户浏览器                  Vercel CDN              Railway 服务器
    │                          │                       │
    ├─ 1. 发起请求 ─────────→  │                       │
    │  GET /api/words/query     │                       │
    │                          │                       │
    │                     ┌────┴────┐                  │
    │                     │ 检查规则 │                  │
    │                     └────┬────┘                  │
    │                          │                       │
    │                     2. 匹配到                    │
    │                     /api/* 代理规则              │
    │                          │                       │
    │                          ├─ 3. 转发请求 ──────→ │
    │                          │  (添加 Origin 头)     │
    │                          │                       │
    │                          │                  ┌────┴────┐
    │                          │                  │ Gunicorn │
    │                          │                  └────┬────┘
    │                          │                       │
    │                          │                  4. 路由匹配
    │                          │                  Flask → words.bp
    │                          │                       │
    │                          │                  ┌────┴────┐
    │                          │                  │ CORS 检查│
    │                          │                  └────┬────┘
    │                          │                       │
    │                          │                  5. 验证 Origin
    │                          │                       │
    │                          │                  ┌────┴────┐
    │                          │                  │ 业务逻辑 │
    │                          │                  │ 查询单词 │
    │                          │                  └────┬────┘
    │                          │                       │
    │                          │                  6. 返回数据
    │                          │                       │
    │                          │ ←─── 7. JSON 响应 ─┤
    │                          │  (含 CORS 头)        │
    │                          │                       │
    │ ←─ 8. 返回给浏览器 ──────┤                       │
    │    (透传响应)            │                       │
    │                          │                       │
    ├─ 9. 渲染数据             │                       │
    │                          │                       │

总耗时: ~200-500ms
├── DNS 解析: ~20ms
├── Vercel CDN: ~50ms
├── 代理转发: ~50ms
├── Railway 处理: ~100-300ms
└── 返回渲染: ~20ms
```

---

## 📊 架构优缺点分析

### 当前架构的优点

#### ✅ 前后端分离
- 开发独立，互不影响
- 可以独立部署和扩展
- 技术栈解耦

#### ✅ 免费部署
- Vercel: 免费托管 + 无限带宽
- Railway: 每月 $5 免费额度
- 总成本: $0 (在免费额度内)

#### ✅ 自动化 CI/CD
- Git Push 即自动部署
- 零配置持续集成
- 零停机时间更新

#### ✅ 全球加速
- Vercel CDN 全球节点
- 用户访问最近的服务器
- 响应时间显著降低

#### ✅ SSL/HTTPS
- 自动 HTTPS 证书
- 安全的数据传输
- SEO 友好

### 当前架构的缺点

#### ⚠️ 数据非持久化
- SQLite 存储在容器中
- 重启会丢失数据
- 需要升级到 PostgreSQL

#### ⚠️ 单点故障
- 只有一个 Railway 实例
- 无负载均衡
- 高并发时可能出现瓶颈

#### ⚠️ 跨域依赖
- 前后端在不同域名
- 需要正确配置 CORS
- 增加了一层网络开销

#### ⚠️ 有限的计算资源
- Railway 免费版资源有限
- 无法处理大量并发
- 适合小型应用

---

## 🚀 架构优化建议

### 短期优化（1-2 周）

#### 1. 升级数据库
```bash
在 Railway 添加 PostgreSQL
├── 点击 "New" → "Database" → "PostgreSQL"
├── Railway 自动设置 DATABASE_URL
└── 重启应用，自动切换到 PostgreSQL
```

#### 2. 添加缓存
```python
# 使用 Flask-Caching
from flask_caching import Cache

cache = Cache(app, config={
    'CACHE_TYPE': 'simple',
    'CACHE_DEFAULT_TIMEOUT': 300
})

@cache.cached(timeout=3600)
def get_word_translation(word):
    # 查询单词
    pass
```

#### 3. 错误监控
```bash
集成 Sentry
├── 前端错误追踪
├── 后端异常监控
└── 性能分析
```

### 中期优化（1-3 个月）

#### 1. 使用 Redis
```
添加 Redis (Railway 插件)
├── 用户会话管理
├── API 响应缓存
└── 任务队列
```

#### 2. CDN 优化
```
静态资源优化
├── 图片压缩和懒加载
├── 代码分割 (Code Splitting)
└── PWA 支持 (离线访问)
```

#### 3. 监控和日志
```
完善监控体系
├── 应用性能监控 (APM)
├── 日志聚合和分析
└── 用户行为分析
```

### 长期优化（3-6 个月）

#### 1. 微服务拆分
```
服务拆分
├── 认证服务
├── 单词查询服务
├── 学习计划服务
└── 统计分析服务
```

#### 2. 使用 CDN + OSS
```
静态资源分离
├── 图片存储到 OSS
├── 配置 CDN 加速
└── 减轻服务器压力
```

#### 3. 自定义域名
```
购买和配置域名
├── 购买域名: learning-english.com
├── Vercel 配置自定义域名
├── Railway 配置自定义域名
└── 配置 DNS 记录
```

---

## 📈 扩展路线图

### 阶段 1: MVP (当前)
```
✅ 基础功能实现
✅ 免费部署
✅ 前后端分离
✅ 自动化部署
```

### 阶段 2: 稳定版
```
□ PostgreSQL 数据库
□ Redis 缓存
□ 错误监控
□ 日志分析
```

### 阶段 3: 增长版
```
□ 用户认证系统
□ 自定义域名
□ 性能优化
□ SEO 优化
```

### 阶段 4: 企业版
```
□ 多租户支持
□ 高可用架构
□ 微服务拆分
□ 全球部署
```

---

## 🔧 关键配置文件

### Railway 配置文件

**`railway.json`**
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "cd backend && gunicorn run:app --bind 0.0.0.0:$PORT",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### Vercel 配置文件

**`frontend/vercel.json`**
```json
{
  "version": 2,
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "https://rare-wonder-production.up.railway.app/api/:path*"
    }
  ]
}
```

### 环境变量配置

**Railway 环境变量:**
```bash
SECRET_KEY=<64位随机字符串>
FLASK_ENV=production
CORS_ORIGINS=https://learning-english-when-whaching-tv.vercel.app,http://localhost:5173
YOUDAO_APP_KEY=<可选>
YOUDAO_APP_SECRET=<可选>
```

**Vercel 环境变量:**
```bash
VITE_API_BASE_URL=https://rare-wonder-production.up.railway.app
```

---

## 📞 关键信息速查

### 域名信息
```
前端: https://learning-english-when-whaching-tv.vercel.app
后端: https://rare-wonder-production.up.railway.app
仓库: https://github.com/qilirampart/Learning-English-when-whaching-Tv
```

### 平台控制台
```
Railway: https://railway.app/project/<project-id>
Vercel:  https://vercel.com/dashboard
GitHub:  https://github.com/qilirampart
```

### 技术支持
```
Railway 文档:  https://docs.railway.app/
Vercel 文档:   https://vercel.com/docs
Flask 文档:    https://flask.palletsprojects.com/
Vue.js 文档:   https://vuejs.org/
```

---

## 🎯 总结

### 架构特点

1. **现代化架构**
   - 前后端分离
   - RESTful API
   - 单页应用 (SPA)

2. **云原生部署**
   - 容器化 (Docker)
   - 自动扩缩容
   - CI/CD 集成

3. **全球加速**
   - CDN 边缘节点
   - HTTPS 加密
   - 智能路由

4. **开发友好**
   - Git 驱动部署
   - 零配置
   - 实时日志

### 核心价值

- ✅ **零成本起步**: 完全免费的部署方案
- ✅ **快速迭代**: Git Push 即部署
- ✅ **全球访问**: CDN 加速，低延迟
- ✅ **易于维护**: 自动化运维，无需服务器管理
- ✅ **可扩展性**: 随时升级到付费计划

---

**文档版本:** v1.0  
**创建日期:** 2025-11-12  
**最后更新:** 2025-11-12  

**架构设计:** AI Assistant  
**部署实施:** 用户 + AI Assistant

